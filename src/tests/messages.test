#
# messages.test -- 
# nca-073-9
# 
# Copyright (c) 1996-2000 by Netcetera AG.
# Copyright (c) 2001 by Apache Software Foundation.
# All rights reserved.
#
# See the file "license.terms" for information on usage and
# redistribution of this file, and for a DISCLAIMER OF ALL WARRANTIES.
#
# @(#) $Id$
#

# -----------------------------------------------------------------------------
# tcltest package
# -----------------------------------------------------------------------------

if {[lsearch [namespace children] ::tcltest] == -1} {
    package require tcltest
    namespace import ::tcltest::*
}

# -----------------------------------------------------------------------------
# errors
# -----------------------------------------------------------------------------
test messages-1.1 {web::send wrong number of arguments} {unixOnly} {
    catch {web::send} msg
    set msg
} {wrong # args: should be "web::send channel cmdnr string ??#?flags?"}

test messages-1.2 {web::send wrong number of arguments} {unixOnly} {
    catch {web::send 1 2 3 4 5} msg
    set msg
} {wrong # args: should be "web::send channel cmdnr string ??#?flags?"}

test messages-1.3 {web::recv wrong number of arguments} {unixOnly} {
    catch {web::recv} msg
    set msg
} {wrong # args: should be "web::recv channel cmdvarname resvarname flagsvarname"}

test messages-1.4 {web::recv wrong number of arguments} {unixOnly} {
    catch {web::recv 1 2 3 4 5} msg
    set msg
} {wrong # args: should be "web::recv channel cmdvarname resvarname flagsvarname"}

test messages-1.5 {web::msgflag wrong number of arguments} {unixOnly} {
    catch {web::msgflag 1 2 3 4 5} msg
    set msg
} {wrong # args: should be "web::msgflag ?flags? ?testflags?"}

test messages-1.6 {web::msgflag set unknown flag} {unixOnly} {
    catch {set flag [web::msgflag gugus]} msg
    set msg
} {unknown flag "gugus"}

test messages-1.7 {web::msgflag test for unknown flag} {unixOnly} {
    set flag [web::msgflag multiple]
    catch {set res  [web::msgflag $flag gugus]} msg
    set msg
} {unknown flag "gugus"}

# -----------------------------------------------------------------------------
# normal operation
# -----------------------------------------------------------------------------
test messages-2.1 {web::send and recieve} {unixOnly} {

    set curTim [clock clicks]
    set fileName [web::tempfile]

    set fileId [open $fileName "w"]
    set cmd  10011
    set flags 131072
    set text "T E S T $curTim"
    web::send $fileId $cmd $text \#$flags
    close $fileId

    set fileId [open $fileName "r"]
    web::recv $fileId cmd res flag

    set expected "$cmd-$text-$flags"
    set res "$cmd-$res-$flag"

    set res [string compare $expected $res]
} {0}

test messages-2.1b {web::send and recieve} {unixOnly} {

    set fileName [web::tempfile]

    set fileId [open $fileName "w"]
    set cmd   10011
    set flags 131072
    set text [string repeat "Test" 100000]
    web::send $fileId $cmd $text \#$flags
    close $fileId

    set fileId [open $fileName "r"]
    web::recv $fileId cmd res flag
    close $fileId

    set expected "$cmd-$text-$flags"
    set res "$cmd-$res-$flag"

    set res [string compare $expected $res]
} {0}

test messages-2.1c {web::send and recieve unicode} {} {

    set fileName [web::tempfile]

    set fileId [open $fileName "w"]
    set cmd  10011
    set flags 131072
    set text "abc\u00c2def123"
    web::send $fileId $cmd $text \#$flags
    close $fileId

    set fileId [open $fileName "r"]

    set expected "$cmd-$text-$flags"

    web::recv $fileId cmd res flag

    set res "$cmd-$res-$flag"

    set res [string compare $expected $res]
} {0}

test messages-2.2 {web::msgflag no arg} {unixOnly} {
    set res [web::msgflag]
} {multiple}

test messages-2.3 {web::msgflag set and test flag} {unixOnly} {
    set flag [web::msgflag multiple]
    set res  [web::msgflag $flag multiple]
} {1}

# cleanup
::tcltest::cleanupTests
